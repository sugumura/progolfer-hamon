/* */ 
module.exports = function(grunt) {
  var net = require('net');
  var _callback;
  var _ports;
  var _opts;
  var _done;
  grunt.registerMultiTask('findopenport', 'Prints a list of active ips.', function() {
    _opts = this.options();
    _done = this.async();
    _ports = _opts['ports'] || [80, 8888, 9000, 9999, 9001];
    checkNext();
  });
  function checkNext() {
    if (!_ports.length) {
      grunt.option(_portName, -1);
      _done();
      return;
    }
    check(_ports.shift(), function(success, port) {
      if (!success) {
        checkNext();
      } else {
        var configNames = Array.isArray(_opts.configName) ? _opts.configName : [_opts.configName];
        configNames.forEach(function(item) {
          grunt.config.set(item, port);
        });
        _done();
      }
    });
  }
  function check(port, callback) {
    var server = net.createServer();
    server.on('error', function(e) {
      callback(false, port);
    });
    server.listen(port, function() {
      callback(true, port);
      server.close();
    });
  }
};
